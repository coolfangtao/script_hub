import streamlit as st
import re
from shared.sidebar import create_common_sidebar

# --- 1. é¡µé¢é…ç½® (å»ºè®®æ”¾åœ¨è„šæœ¬é¡¶éƒ¨) ---
st.set_page_config(
    page_title="Bç«™æ ‡é¢˜æå–å·¥å…·",
    page_icon="ğŸ“Œ"
)

# --- 2. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---
def extract_titles(html_content: str) -> list[str]:
    """
    ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä»…ä»åŒ…å« class="title" çš„æ ‡ç­¾ä¸­æå– title å†…å®¹ã€‚

    Args:
        html_content: åŒ…å«HTMLçš„å­—ç¬¦ä¸²ã€‚

    Returns:
        ä¸€ä¸ªåŒ…å«æ‰€æœ‰åŒ¹é…åˆ°çš„æ ‡é¢˜çš„åˆ—è¡¨ã€‚
    """
    if not html_content:
        return []

    # ===================================================================
    # æ›´æ–°åçš„æ­£åˆ™è¡¨è¾¾å¼ï¼š
    # å®ƒä¼šæŸ¥æ‰¾ä¸€ä¸ª title="..." å±æ€§ï¼Œå¹¶ä¸”è¿™ä¸ªå±æ€§åé¢å¿…é¡»è·Ÿç€ class="title"ã€‚
    # è¿™ç¡®ä¿äº†æˆ‘ä»¬åªæ•è·è§†é¢‘åˆ—è¡¨é¡¹çš„æ ‡é¢˜ï¼Œè€Œå¿½ç•¥å…¶ä»–æ— å…³çš„titleã€‚
    # ===================================================================
    precise_regex = r'title="([^"]+)"\s+class="title"'

    return re.findall(precise_regex, html_content)

# --- 3. ä¾§è¾¹æ  ---
try:
    create_common_sidebar()
except Exception as e:
    st.sidebar.error(f"åŠ è½½ä¾§è¾¹æ å¤±è´¥: {e}")


# --- 4. ä¸»ç•Œé¢UI ---

# é¡µé¢ä¸»æ ‡é¢˜
st.title("ğŸ“Œ Bç«™æ ‡é¢˜æå–å·¥å…·")
st.caption("ä¸€ä¸ªç®€å•çš„å°å·¥å…·ï¼Œç”¨äºä» Bilibili æ’­æ”¾åˆ—è¡¨ç­‰é¡µé¢çš„ HTML æºç ä¸­æ‰¹é‡æå–è§†é¢‘æ ‡é¢˜ã€‚")

# ä½¿ç”¨å¯æŠ˜å å®¹å™¨æ¥ç»„ç»‡è¾“å…¥åŒºåŸŸï¼Œä½¿ç•Œé¢æ›´æ•´æ´
with st.expander("ç¬¬ä¸€æ­¥ï¼šç²˜è´´HTMLå†…å®¹", expanded=True):
    st.markdown("""
    1. åœ¨Bç«™çš„æ’­æ”¾åˆ—è¡¨é¡µé¢ï¼ˆæˆ–å…¶ä»–éœ€è¦æå–æ ‡é¢˜çš„é¡µé¢ï¼‰ï¼Œå³é”®ç‚¹å‡»é¡µé¢ç©ºç™½å¤„ã€‚
    2. é€‰æ‹© **â€œæ˜¾ç¤ºç½‘é¡µæºä»£ç â€** (View Page Source) æˆ– **â€œæ£€æŸ¥â€** (Inspect)ã€‚
    3. **å…¨é€‰ (Ctrl+A)** å¹¶ **å¤åˆ¶ (Ctrl+C)** æºä»£ç ã€‚
    4. å°†å¤åˆ¶çš„å†…å®¹ç²˜è´´åˆ°ä¸‹æ–¹çš„æ–‡æœ¬æ¡†ä¸­ã€‚
    """)
    html_input = st.text_area(
        "åœ¨æ­¤å¤„ç²˜è´´HTMLæºä»£ç ...",
        height=300,
        label_visibility="collapsed"
    )

# æå–æŒ‰é’®å’Œç»“æœå±•ç¤º
if st.button("ğŸš€ å¼€å§‹æå–", type="primary", use_container_width=True):
    if not html_input.strip():
        # æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©ºæˆ–ä»…åŒ…å«ç©ºç™½å­—ç¬¦
        st.warning("âš ï¸ è¯·å…ˆç²˜è´´HTMLå†…å®¹å†è¿›è¡Œæå–ã€‚")
    else:
        # è°ƒç”¨å‡½æ•°æ‰§è¡Œæå–é€»è¾‘
        titles = extract_titles(html_input)

        st.header("ç¬¬äºŒæ­¥ï¼šå¤åˆ¶æå–ç»“æœ")

        if titles:
            # å°†ç»“æœåˆ—è¡¨è½¬æ¢ä¸ºä»¥æ¢è¡Œç¬¦åˆ†éš”çš„å­—ç¬¦ä¸²
            result_text = "\n".join(titles)

            # st.code è‡ªå¸¦å¤åˆ¶æŒ‰é’®ï¼Œéå¸¸é€‚åˆå±•ç¤ºç»“æœ
            st.code(result_text, language='text')

            # æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
            st.success(f"ğŸ‰ æˆåŠŸæå–äº† {len(titles)} ä¸ªæ ‡é¢˜ï¼ç‚¹å‡»ä¸Šæ–¹ç»“æœæ¡†å³ä¸Šè§’çš„å›¾æ ‡å³å¯ä¸€é”®å¤åˆ¶ã€‚")
        else:
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ ‡é¢˜ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            st.error("âŒ æœªæ‰¾åˆ°ä»»ä½•æ ‡é¢˜ã€‚è¯·ç¡®è®¤æ‚¨å¤åˆ¶çš„æ˜¯å®Œæ•´çš„HTMLæºä»£ç ï¼Œå¹¶ä¸”å…¶ä¸­åŒ…å« `title=\"...\"` æ ¼å¼çš„å†…å®¹ã€‚")